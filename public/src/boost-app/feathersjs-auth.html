<link rel="import" href="../../bower_components/polymer/polymer-element.html">

<dom-module id="feathersjs-auth">
  <script>
    class FeathersjsAuth extends Polymer.Element {
      static get is() {
        return 'feathersjs-auth';
      }

      static get properties() {
        return {
          app: {
            type: Object,
            observer: '_connectedChanged',
          },
          connected: {
            type: Boolean,
            observer: '_connectedChanged',
          },
          loggedIn: {
            type: Boolean,
            value: false,
            readOnly: true,
            notify: true,
          }
        };
      }

      _connectedChanged() {
        if (this.app && this.connected) {
          console.log("feathersjs-auth Init Feathers Config");
          this._configFeathers();
        }
      }

      _configFeathers() {
        const authConfig = {
          header: 'Authorization',
          path: '/authentication',
          jwtStrategy: 'jwt',
          entity: 'user',
          service: 'users',
          cookie: 'feathers-jwt',
          storageKey: 'feathers-jwt',
          storage: window.localStorage
        };

        this.app.configure(feathers.authentication(authConfig));

        this.app.on('reauthentication-error', this._feathersAuthErrorHandler);

        this.app
          .authenticate()
          .then((success) => {
            console.log("feathersjs-auth Logged in");
            this._setLoggedIn(true);
          })
          .catch((error) => {
            console.log("feathersjs-auth Not logged in", error);
            this._setLoggedIn(false);
          })
      }

      _feathersAuthErrorHandler(error) {
        console.error("feathersjs-auth Reauth error: ", error);
        this._setLoggedIn(false);
      }
    }

    window.customElements.define(FeathersjsAuth.is, FeathersjsAuth);

  </script>
</dom-module>
